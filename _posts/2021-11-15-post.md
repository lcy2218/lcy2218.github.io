---
layout: post
title:  交换机通用知识-堆叠
date: 2021-11-15 22:23 +0900
category: sun-swicth
---
<!-- TOC -->

- [0x0 堆叠技术](#0x0-堆叠技术)
    - [0x0.1 堆叠技术原理](#0x01-堆叠技术原理)
- [0x1 堆叠相关技术点](#0x1-堆叠相关技术点)
    - [0x1.1 流量本地优先转发](#0x11-流量本地优先转发)
    - [0x1.2 堆叠分裂](#0x12-堆叠分裂)
    - [0x1.3 多主检测](#0x13-多主检测)
    - [0x1.4 保留端口](#0x14-保留端口)
    - [0x1.5 DHCP多主分配功能优化](#0x15-dhcp多主分配功能优化)

<!-- /TOC -->
## 0x0 堆叠技术

### 0x0.1 堆叠技术原理

- 所谓堆叠，是指把多个支持堆叠特性的单机设备采用堆叠线缆以环型或链型拓扑结构组合在一起，从逻辑上合为一台整体设备。**堆叠设备从逻辑上像一台设备实现报文转发**。堆叠的不同设备主要承担三种角色：主交换机、备份交换机、从交换机，他们都是堆叠成员，都属于成员交换机。配置只会在主备交换机间同步。堆叠在一起的以太网交换机可看作为一个设备，用户可通过主交换机实现对堆叠内所有交换机的管理。
- 堆叠技术优势
  1. 解决汇聚层、核心层设备冗余问题，增加**汇聚层、核心层可靠性**；
  2. 易管理、端口扩容，多台交换机设备部署后虚拟成一台，双上行提供链路冗余的同时并扩展端口数量，一定程度减少施工和线路成本，可以进行统一管理，降低运维难度；

## 0x1 堆叠相关技术点

### 0x1.1 流量本地优先转发

- **即从本设备进入的流量，优先从本设备相应的接口转发出去**。如果不支持本地流量转发，本交换机收到多个数据包后会有一半交给备机转发

![](/images/20211115-1.png)

### 0x1.2 堆叠分裂

- **堆叠分裂是指稳定运行的堆叠系统中带电移出部分成员交换机，或者堆叠线缆多点故障导致一个堆叠系统变成多个堆叠系统**

### 0x1.3 多主检测

- 一个堆叠分裂后，可能产生多个具有相同IP地址和MAC地址的堆叠系统。**为防止堆叠分裂后，产生多个具有相同IP地址和MAC地址的堆叠系统**，引起网络故障，必须进行直连检测或代理检测。

1. 直连检测：是指堆叠成员交换机间通过**普通线缆直连的专用链路进行多主检测**。在交换机业务口充足，有多余的业务口可以用时可使用直连检测，需要占用业务口
2. 代理检测：代理检测方式是在堆叠交换机的聚合口上启用代理检测，此种检测方式要求堆叠交换机中的所有成员交换机都与代理设备连接，并将这些链路加入同一个链路聚合组内，**需要使用lacp链路聚合**，并且代理设备需要是支持堆叠功能及后续版本的安视交换机。
![](/images/20211115-2.png)

### 0x1.4 保留端口

- 在出现堆叠分裂时，配置为保留端口的接口不会被关闭，仍能正常转发业务

### 0x1.5 DHCP多主分配功能优化

- 出现双主情况时（堆叠彻底分裂，堆叠线和多主检测链路都断开），新接入的设备避免分配相同IP地址冲突导致终端网络异常。**我们的做法是分裂后的两台交换机分别只分配单数和双数的IP地址**。为避免出现地址不够用的情况，建议在配置dhcp时，分配的地址数至少是实际要用到的地址数的两倍。


